# Maintainer: eabarriosTGC <tu@email.com>
pkgbase=lib32-mesa-amd-bc250
pkgname=(lib32-mesa-amd-bc250 lib32-vulkan-radeon-amd-bc250)
pkgver=24.3.1
pkgrel=1
epoch=1
pkgdesc="Mesa 24.3.x drivers (32-bit) with fixes for AMD BC-250"
url="https://www.mesa3d.org/"
arch=(x86_64)
license=('MIT' 'BSD' 'SGI-B-2.0')
makedepends=(
  lib32-clang lib32-cmake lib32-elfutils lib32-expat lib32-gcc-libs lib32-glibc 
  lib32-libdrm lib32-libelf lib32-libglvnd lib32-libva lib32-libvdpau 
  lib32-libx11 lib32-libxcb lib32-libxext lib32-libxfixes lib32-libxml2 
  lib32-libxrandr lib32-libxshmfence lib32-libxxf86vm lib32-llvm lib32-llvm-libs 
  lib32-lm_sensors lib32-rust-libs lib32-spirv-llvm-translator lib32-spirv-tools 
  lib32-systemd lib32-vulkan-icd-loader lib32-wayland lib32-xcb-util-keysyms 
  lib32-zlib lib32-zstd meson python-mako python-packaging rust-bindgen clang
)
options=('!lto')
source=(
  "https://mesa.freedesktop.org/archive/mesa-${pkgver}.tar.xz"
  "0001-adjust-navi10-range.patch"
)
sha256sums=('SKIP' 'SKIP')

prepare() {
  cd mesa-$pkgver
  patch -p1 -i ../0001-adjust-navi10-range.patch
  echo "$pkgver-bc250" > VERSION
}

build() {
  export CC="gcc -m32"
  export CXX="g++ -m32"
  export PKG_CONFIG_PATH="/usr/lib32/pkgconfig"
  export LLVM_CONFIG="/usr/bin/llvm-config32"
  
  local meson_options=(
    --cross-file lib32
    -D b_ndebug=true
    -D gallium-drivers=radeonsi,zink,swrast,virgl
    -D vulkan-drivers=amd,swrast
    -D vulkan-layers=device-select,overlay
    -D platforms=x11,wayland
    -D gles1=disabled
    -D gles2=enabled
    -D opengl=true
    -D glx=dri
    -D egl=enabled
    -D gbm=enabled
  )
  
  arch-meson mesa-$pkgver build "${meson_options[@]}"
  meson compile -C build
}

package_lib32-mesa-amd-bc250() {
  depends=(lib32-libdrm lib32-libelf lib32-libglvnd lib32-libx11 lib32-libxcb lib32-wayland lib32-zstd lib32-llvm-libs mesa-amd-bc250)
  provides=(lib32-mesa lib32-opengl-driver)
  conflicts=(lib32-mesa)
  replaces=(lib32-mesa)

  meson install -C build --destdir "$pkgdir"

  # Separar Vulkan y limpiar
  cd "$pkgdir"
  rm -rf usr/include usr/share/doc usr/share/man
  
  mkdir -p ../vulkan32-pkg/usr/lib32
  mkdir -p ../vulkan32-pkg/usr/share/vulkan/icd.d
  
  mv usr/lib32/libvulkan_radeon.so ../vulkan32-pkg/usr/lib32/ 2>/dev/null || true
  mv usr/share/vulkan/icd.d/radeon_icd*.json ../vulkan32-pkg/usr/share/vulkan/icd.d/ 2>/dev/null || true

  install -Dm644 mesa-$pkgver/docs/license.rst -t "$pkgdir/usr/share/licenses/$pkgname"
}

package_lib32-vulkan-radeon-amd-bc250() {
  pkgdesc="Vulkan RADV driver (32-bit) for AMD BC-250"
  depends=(lib32-mesa-amd-bc250 lib32-vulkan-icd-loader vulkan-radeon-amd-bc250)
  provides=(lib32-vulkan-radeon lib32-vulkan-driver)
  conflicts=(lib32-vulkan-radeon)
  
  install -d "$pkgdir/usr/lib32"
  install -d "$pkgdir/usr/share/vulkan/icd.d"
  
  mv ../vulkan32-pkg/usr/lib32/* "$pkgdir/usr/lib32/" 2>/dev/null || true
  mv ../vulkan32-pkg/usr/share/vulkan/icd.d/* "$pkgdir/usr/share/vulkan/icd.d/" 2>/dev/null || true
  
  install -Dm644 mesa-$pkgver/docs/license.rst -t "$pkgdir/usr/share/licenses/$pkgname"
}
